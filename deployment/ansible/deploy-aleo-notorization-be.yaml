---
- name: Deploy Aleo Notarization Backend
  hosts: all
  become: yes
  vars:
    deploy_dir: "{{ lookup('env', 'DEPLOY_DIR') }}"
    app_name: "{{ lookup('env', 'APP') }}"
    tag_name: "{{ lookup('env', 'GITHUB_REF_NAME') }}"
    repository: "{{ lookup('env', 'GITHUB_REPOSITORY') }}"

  tasks:
    - name: Ensure deploy directory exists
      file:
        path: "{{ deploy_dir }}"
        state: directory

    - name: Fetch latest code from GitHub
      git:
        repo: "git@github.com:{{ repository }}.git"
        dest: "{{ deploy_dir }}"
        version: "{{ tag_name }}"
        force: yes
        accept_hostkey: yes

    - name: Create .env file
      copy:
        dest: "{{ deploy_dir }}/.env"
        content: |
          APP={{ app_name }}
          IMAGE_TAG={{ tag_name }}

    - name: Stop running containers (if any)
      command: make docker-stop
      args:
        chdir: "{{ deploy_dir }}"
      ignore_errors: yes

    - name: Remove dangling docker images
      command: docker image prune -af

    - name: Start containers with the tag
      command: make docker-run IMAGE_TAG={{ tag_name }}
      args:
        chdir: "{{ deploy_dir }}"

    - name: Extract enclave artifacts
      command: make extract-enclave-artifacts
      args:
        chdir: "{{ deploy_dir }}"
